<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="fr">
<head>
    <title>duck404</title>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7/jquery.js"></script>
    <script type="text/javascript" src="http://cdn.gamequeryjs.com/jquery.gamequery.js"></script>
    <script type="text/javascript" src="js/main.js"></script>
    <script type="text/javascript">


        function explodePlayer(playerNode){
            playerNode.children().remove();
            //playerNode.addSprite("explosion",{animation: playerAnimation["explode"], width: 100, height: 26})
            alert("Przegrales MADAAFAKAAA!")
            playerHit = true;
        }


        function Player(node){

            this.node = node;
            //this.animations = animations;

            this.grace = false;
            this.replay = 1;
            this.shield = 1;
            this.respawnTime = -1;

            // This function damage the ship and return true if this cause the ship to die
            this.damage = function(){
//                if(!this.grace){
//                    this.shield--;
//                    if (this.shield == 0){
//                        return true;
//                    }
//                    return false;
//                }
                return true;
            };

            // this try to respawn the ship after a death and return true if the game is over
            this.respawn = function(){
                this.replay--;
                if(this.replay==0){
                    return true;
                }

                this.grace 	= true;
                this.shield	= 3;

                this.respawnTime = (new Date()).getTime();
                $(this.node).fadeTo(0, 0.5);
                return false;
            };

            this.update = function(){
                if((this.respawnTime > 0) && (((new Date()).getTime()-this.respawnTime) > 3000)){
                    this.grace = false;
                    $(this.node).fadeTo(500, 1);
                    this.respawnTime = -1;
                }
            }

            return true;
        }


        function Enemy(node) {
            this.speedx = -5;
            this.speedy = 0;
            this.node = $(node);


            this.update = function(playerNode){
                this.updateX(playerNode);
                this.updateY(playerNode);
            };
            this.updateX = function(playerNode){
                this.node.x(this.speedx, true);
            };
            this.updateY= function(playerNode){
//                var newpos = parseInt(this.node.css("top"))+this.speedy;
//                this.node.y(this.speedy, true);
            };
        }

        function Minion(node) {
            this.node = $(node);
        }
        Minion.prototype = new Enemy();
        Minion.prototype.updateY = function (playerNode) {

//            if (this.node.y() > (PLAYGROUND_HEIGHT - 100)) {
//                this.node.y(-2, true)
//            }
        }

        $(document).ready(function() {
            currentPosition = 1;
                            position = ["-125px", "0px", "125px"];
            var onUp = function(){
                            console.log("UP")
                            if (currentPosition == 0) {
                                return
                            }
                            currentPosition--;
                            $("#duck").css("top", position[currentPosition]);
            }

            var onDown = function(){
                        if (currentPosition == 2) {
                            return
                        }
                        currentPosition++;
                        $("#duck").css("top", position[currentPosition]);
            }

             var div=document.getElementsByTagName('div')[0];

             div.addEventListener('swu', onUp, false);
             div.addEventListener('swd', onDown, false);

            div.addEventListener('touchstart',function(e){e.preventDefault()},false);


            var PLAYGROUND_HEIGHT = 500;
            var PLAYGROUND_WIDTH = 700;
            var REFRESH_RATE = 5;

            $("#playground").playground({height: PLAYGROUND_HEIGHT, width: PLAYGROUND_WIDTH});

            var background1 = new $.gameQuery.Animation({imageURL: "img/background/background-03.png"});
            var background11 = new $.gameQuery.Animation({imageURL: "img/background/background-03.png"});
            var background2 = new $.gameQuery.Animation({imageURL: "img/background/background-01.png"});
            var background22 = new $.gameQuery.Animation({imageURL: "img/background/background-01.png"});
            var background3 = new $.gameQuery.Animation({imageURL: "img/background/background-04.png"});
            var background33 = new $.gameQuery.Animation({imageURL: "img/background/background-04.png"});

            $.playground()
                    .addGroup("background", {width: PLAYGROUND_WIDTH, height: PLAYGROUND_HEIGHT})
                        .addSprite("background1", {
                            animation: background1,
                            width: PLAYGROUND_WIDTH,
                            height: PLAYGROUND_HEIGHT
                        })
                        .addSprite("background11", {
                            animation: background1,
                            width: PLAYGROUND_WIDTH,
                            height: PLAYGROUND_HEIGHT,
                            posx: PLAYGROUND_WIDTH
                        })
                        .addSprite("background2", {
                            animation: background2,
                            width: PLAYGROUND_WIDTH,
                            height: PLAYGROUND_HEIGHT
                        })
                        .addSprite("background22", {
                            animation: background2,
                            width: PLAYGROUND_WIDTH,
                            height: PLAYGROUND_HEIGHT,
                            posx: PLAYGROUND_WIDTH
                        })
                        .addSprite("background3", {
                            animation: background3,
                            width: PLAYGROUND_WIDTH,
                            height: PLAYGROUND_HEIGHT
                        })
                        .addSprite("background33", {
                            animation: background3,
                            width: PLAYGROUND_WIDTH,
                            height: PLAYGROUND_HEIGHT,
                            posx: PLAYGROUND_WIDTH
                        })
                    .end();

            var duck = [];
            duck["body"] = new $.gameQuery.Animation({imageURL: "img/duck100x100.png"});

            var enemiesSize = [];
            enemiesSize.push({
                width: 227,
                height: 100
            });
            enemiesSize.push({
                width: 233,
                height: 100
            });
            enemiesSize.push({
               width: 170,
               height: 100
            });
            var enemies = []
            enemies[0] = new $.gQ.Animation({
                imageURL: "img/submarine.png",
                numberOfFrame: 1,
                delta: 52,
                rate: 60,
                type: $.gQ.ANIMATION_VERTICAL
            });
            enemies[1] = new $.gQ.Animation({
                imageURL: "img/boat.png",
                numberOfFrame: 1,
                delta: 42,
                rate: 60,
                type: $.gQ.ANIMATION_VERTICAL
            });
            enemies[2] = new $.gQ.Animation({
                imageURL: "img/airplane.png",
                numberOfFrame: 1,
                delta: 100,
                rate: 60,
                type: $.gQ.ANIMATION_VERTICAL
            });

            $.playground()
                    .addGroup("objects", {width: PLAYGROUND_WIDTH, height: PLAYGROUND_HEIGHT})
                        .addGroup("duck", {posx: 0, posy: PLAYGROUND_HEIGHT / 2 - 50, width: 100, height: 100})
                            .addSprite("duckBody", {animation: duck["body"], posx: 0, posy: 0, width: 100, height: 100})
                        .end()
                    .end()

            $("#duck")[0].player = new Player($("#duck"));



            currentPosition = 1;

            $(document).keydown(function (e) {

                position = ["-125px", "0px", "125px"];

                switch (e.keyCode) {
                    case 38: //up
                        onUp();
                        break;
                    case 40: //down
                        onDown();
                        break;
                }
            });

            var backSpeed = 2;
            var centerSpeed = 3;
            var frontSpeed = 5;



            //animate enemies
            $.playground().registerCallback(function () {


                var collision = $("#duckBody").collision(".enemy");


                if(collision.length > 0)
                    console.log(collision);
//                return;
                $(".enemy").each(function(){
                    this.enemy.update($("#duck"));
                    var posx = $(this).x();
                    if((posx+100) < 0){
                        $(this).remove();
                        return;
                    }


                    var duckPosition = $("#duckBody").offset();
                    var enemyPosition = $(this).offset();

                    function range(from, to) {
                        var array = []
                        while(from<=to) {
                            array.push(from)
                            from++;
                        }
                        return array;
                    }

                    function intersect(a, b)
                    {
                        var ai=0, bi=0;
                        var result = new Array();

                        while( ai < a.length && bi < b.length )
                        {
                            if      (a[ai] < b[bi] ){ ai++; }
                            else if (a[ai] > b[bi] ){ bi++; }
                            else /* they're equal */
                            {
                                result.push(a[ai]);
                                ai++;
                                bi++;
                            }
                        }

                        return result;
                    }

                    var duckXRange = range(duckPosition.left, duckPosition.left+$("#duckBody").width());
                    var enemyXRange = range(enemyPosition.left, enemyPosition.left+$(this).width());

                    var duckYRange = range(duckPosition.top, duckPosition.top+$("#duckBody").height());
                    var enemyYRange = range(enemyPosition.top, enemyPosition.top+$(this).height());

                    if (intersect(duckXRange, enemyXRange).length> 0 && intersect(duckYRange, enemyYRange).length) {


                        $(this).removeClass("enemy");
                        $(this).remove();
//                        //The player has been hit!
                        if ($("#duck")[0].player.damage()) {
                            explodePlayer($("#duck"));
                        }
                    }
//                    }
                });
            }, REFRESH_RATE);

            //generate enemies
            $.playground().registerCallback(function () {

                var name = "enemy1_" + Math.ceil(Math.random() * 1000);
                var enemyType = parseInt(Math.random()*10) % 3;

                var enemyPositions = [350, 200, 50];
                var position = enemyPositions[enemyType];

                $("#objects").addSprite(name, {animation: enemies[enemyType], posx: PLAYGROUND_WIDTH, posy: position, width: enemiesSize[enemyType].width, height: enemiesSize[enemyType].height});
                $("#" + name).addClass("enemy");
                $("#" + name)[0].enemy = new Minion($("#" + name));


            }, 2000);

            //animate waves
            $.playground().registerCallback(function () {
                //Offset all the pane:
                var newPos = (parseInt($("#background1").css("left")) - backSpeed - PLAYGROUND_WIDTH)
                        % (-2 * PLAYGROUND_WIDTH) + PLAYGROUND_WIDTH;
                $("#background1").css("left", newPos);

                var newPos = (parseInt($("#background11").css("left")) - backSpeed)
                        % (-2 * PLAYGROUND_WIDTH);
                $("#background11").css("left", newPos);

                newPos = (parseInt($("#background2").css("left")) - centerSpeed - PLAYGROUND_WIDTH)
                % (-2 * PLAYGROUND_WIDTH) + PLAYGROUND_WIDTH;
                $("#background2").css("left", newPos);

                newPos = (parseInt($("#background22").css("left")) - centerSpeed)
                % (-2 * PLAYGROUND_WIDTH);
                $("#background22").css("left", newPos);

                newPos = (parseInt($("#background3").css("left")) - frontSpeed - PLAYGROUND_WIDTH)
                % (-2 * PLAYGROUND_WIDTH) + PLAYGROUND_WIDTH;
                $("#background3").css("left", newPos);

                newPos = (parseInt($("#background33").css("left")) - frontSpeed)
                % (-2 * PLAYGROUND_WIDTH);
                $("#background33").css("left", newPos);
            }, REFRESH_RATE);

            $.playground().startGame(function () {
            });

            $("#playground").click(function(){
                console.log("click");
            });
        });
    </script>
    <style type="text/css">
        html,body{
            margin: 0;
            padding: 0;
            background: black;
        }
    </style>
</head>
<body>
<div id="playground" style="width: 700px; height: 500px; background: white;">

</div>
</body>
</html>